<!-- Tabs -->
<div class="border-b mb-6" *ngIf="tree?.length">
    <div class="flex gap-8">
        <button *ngFor="let t of tree; let i = index" (click)="selectTab(i)"
            class="relative pb-3 -mb-px px-2 text-sm font-medium text-gray-600 hover:text-gray-900"
            [class.text-gray-900]="activeTypeIndex === i">
            {{ t.type }}
            <span class="absolute left-0 -bottom-[1px] h-0.5 rounded-full"
                [style.width.px]="activeTypeIndex === i ? 36 : 0"
                [style.background]="typeColors[t.type] || typeColors['Other']"
                [style.transition]="'width .2s ease'"></span>
        </button>
    </div>
</div>

<!-- Folder grid (categories of the active tab) -->
<ng-container *ngIf="activeTypeNode as active">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-6" *ngIf="active?.categories?.length; else noCats">
        <div *ngFor="let c of active.categories"
            (click)="openFolder({category_id: c.category_id, category_name: c.category_name})"
            class="group cursor-pointer relative rounded-2xl p-5 shadow-sm border hover:shadow-md transition"
            [style.background]="accentForType(active.type)">
            <!-- folded corner -->
            <div class="absolute right-3 top-3 h-7 w-7 rounded-full flex items-center justify-center"
                [style.background]="(typeColors[active.type] || typeColors['Other']) + '33'">
                <span class="text-xs" [style.color]="typeColors[active.type] || typeColors['Other']">üìÅ</span>
            </div>

            <div class="text-sm font-semibold" [style.color]="typeColors[active.type] || typeColors['Other']">
                {{ c.category_name }}
            </div>
            <div class="text-gray-600 text-sm mt-1">
                {{ (c.resources.length || 0) | number }} Res
            </div>

            <div class="pointer-events-none absolute inset-0 rounded-2xl"
                style="background: radial-gradient(100px 60px at 40px 20px, #fff3 0, #0000 70%);"></div>
        </div>
    </div>

    <ng-template #noCats>
        <div class="text-center text-gray-500 py-14">No resources found for this type.</div>
    </ng-template>
</ng-container>

<!-- Drawer / list (uses selectedCategory) -->
<ng-container *ngIf="selectedCategory as sel">
    <div class="mt-8 rounded-2xl bg-white border shadow-sm overflow-hidden" *ngIf="sel">
        <div class="flex items-center justify-between px-5 py-4 border-b">
            <div class="flex items-center gap-3">
                <div class="h-8 w-8 rounded-lg flex items-center justify-center"
                    [style.background]="accentForType(activeTypeNode.type)">
                    üìÇ
                </div>
                <div>
                    <div class="font-semibold">{{ sel.category_name }}</div>
                    <div class="text-xs text-gray-500">
                        {{ (sel.resources.length || 0) | number }} Res
                    </div>
                </div>
            </div>
            <button class="text-sm text-gray-500 hover:text-gray-800" (click)="closeFolder()">Close</button>
        </div>

        <!-- Cards body (replaces the divide-y list) -->
        <div class="p-5">
            <div *ngIf="sel.resources?.length; else emptyFolder"
                class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">

                <div *ngFor="let r of sel.resources"
                    class="group bg-white border border-gray-200 rounded-2xl shadow-sm hover:shadow-md hover:border-gray-300 transition p-6"
                    matTooltip="{{ r.res_description || 'No description' }}"
                    [matTooltipDisabled]="!r.res_description"
                    matTooltipPosition="above"
                    [matTooltipShowDelay]="150"
                    [matTooltipHideDelay]="0"
                    matTooltipClass="resource-tooltip">

                    <!-- Card header -->
                    <div class="p-4 pb-2 pl-4 flex items-start gap-3">
                        <div class="h-10 w-10 rounded-xl flex items-center justify-center p-4"
                            [style.background]="accentForType(activeTypeNode.type)">
                            {{ iconForType(activeTypeNode.type) }}
                        </div>

                        <div class="min-w-0 flex-1 p-6">
                            <div class="flex items-start gap-2">
                                <div class="font-medium truncate" [title]="r.res_title">{{ r.res_title }}</div>
                                <span class="ml-auto text-[10px] px-2 py-0.5 rounded-full"
                                    [style.background]="visColor(r.visibility) + '22'"
                                    [style.color]="visColor(r.visibility)">
                                    {{ r.visibility }}
                                </span>
                            </div>

                            <div class="text-sm text-gray-500 line-clamp-2 mt-1" *ngIf="r.res_description">
                                {{ r.res_description }}
                            </div>
                        </div>
                    </div>

                    <!-- Card footer -->
                    <div class="px-4 pb-4 pt-2 flex items-center justify-between text-xs text-gray-500">
                        <span>{{ r.created_at | date:'mediumDate' }}</span>

                        <div class="flex items-center gap-2">
                            <a *ngIf="r.res_url && hrefFor(r.res_url) as href"
                                class="text-sm px-3 py-1.5 rounded-lg border hover:bg-gray-50" [href]="href"
                                target="_blank" rel="noopener">
                                Open
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <ng-template #emptyFolder>
                <div class="border border-dashed rounded-xl p-10 text-center text-gray-500">
                    No files in this folder yet.
                </div>
            </ng-template>
        </div>


        <!-- <div class="divide-y">
            <div *ngFor="let r of sel.resources" class="px-5 py-4 flex items-start gap-4">
                <div class="h-10 w-10 rounded-lg flex items-center justify-center bg-gray-50">
                    {{ iconForType(activeTypeNode.type) }}
                </div>

                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-3">
                        <div class="font-medium truncate">{{ r.res_title }}</div>
                        <span class="text-[10px] px-2 py-0.5 rounded-full"
                            [style.background]="visColor(r.visibility) + '22'" [style.color]="visColor(r.visibility)">
                            {{ r.visibility }}
                        </span>
                    </div>

                    <div class="text-sm text-gray-500 line-clamp-2" *ngIf="r.res_description">
                        {{ r.res_description }}
                    </div>
                    <div class="text-xs text-gray-400 mt-1">
                        {{ r.created_at | date:'mediumDate' }}
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <a *ngIf="r.res_url && hrefFor(r.res_url) as href"
                        class="text-sm px-3 py-1.5 rounded-lg border hover:bg-gray-50" [href]="href" target="_blank"
                        rel="noopener">
                        Open
                    </a>

                </div>
            </div>

            <div *ngIf="!sel.resources?.length" class="px-5 py-10 text-center text-gray-500">
                No files in this folder yet.
            </div>
        </div> -->
    </div>
</ng-container>