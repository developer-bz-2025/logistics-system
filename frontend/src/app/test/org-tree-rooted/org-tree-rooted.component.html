<!-- Loading / Error -->
<!-- <div *ngIf="loading" class="p-4 text-sm text-gray-600">Loading organizationâ€¦</div> -->
<div *ngIf="loading" class="mb-6 text-sm text-gray-500 loader"></div>

<div *ngIf="!loading && error" class="p-4 text-sm text-red-600">{{ error }}</div>
<div *ngIf="!loading && !error && org" class="tree-wrapper">

  <div class="header">
    <div class="title">ğŸŒ³  Structure</div>
    <div class="roles">
      <span class="pill sa" *ngFor="let sa of superAdmin()">ğŸ§‘â€ğŸ’¼ğŸ‘‘ {{ sa.name }}</span>
      <span class="pill cl" *ngFor="let c of cLevels()">ğŸ§‘â€ğŸ’¼ğŸ›ï¸ {{ c.name }}</span>
    </div>
  </div>

  <div class="tree">
    <ul class="lvl">
      <!-- ROOT -->
      <li>
        <div class="node root" (click)="toggleRoot()" [attr.aria-expanded]="rootOpen">
          ğŸŒ± Organization
          <span class="badge">{{ allEntities().length }} entities</span>
        </div>

        <!-- ENTITIES -->
        <ul class="lvl" *ngIf="rootOpen">
          <li *ngFor="let e of allEntities(); trackBy: trackByEntity">
            <div class="node entity"
                 (click)="toggleEntity(e.id)"
                 [attr.aria-expanded]="isEntityOpen(e.id)">
              ğŸ¢ {{ e.name }}
              <span class="badge">{{ e.countriesCount }} {{ e.countriesCount===1 ? 'country' : 'countries' }}</span>
              <ng-container *ngIf="entityHead(e.id).length; else noHead">
                <span class="pill head" *ngFor="let h of entityHead(e.id)">ğŸ§‘â€ğŸ’¼ğŸ¢ {{ h.name }}</span>
              </ng-container>
              <ng-template #noHead><span class="pill muted">No head</span></ng-template>
            </div>

            <!-- COUNTRIES FOR ENTITY -->
            <ul class="lvl" *ngIf="isEntityOpen(e.id)">
              <li *ngFor="let c of countriesForEntity(e.id); trackBy: trackByCountry">
                <div class="node country"
                     (click)="toggleCountry(e.id, c.id); $event.stopPropagation()"
                     [attr.aria-expanded]="isCountryOpen(e.id,c.id)">
                  ğŸŒ {{ c.name }}
                  <span class="badge">{{ unitsFor(e.id, c.id).length }} units</span>
                  <ng-container *ngIf="countryDirector(e.id, c.id).length; else noDir">
                    <span class="pill cdir" *ngFor="let d of countryDirector(e.id, c.id)">ğŸ§‘â€ğŸ’¼ğŸŒ {{ d.name }}</span>
                  </ng-container>
                  <ng-template #noDir><span class="pill muted">No director</span></ng-template>
                </div>

                <!-- UNITS -->
                <ul class="lvl" *ngIf="isCountryOpen(e.id,c.id)">
                  <li *ngFor="let u of unitsFor(e.id, c.id); trackBy: trackByUnit">
                    <div class="node unit">
                      <div class="unit-head">
                        <span>ğŸ·ï¸ {{ u.name }}</span>
                        <span class="badge">{{ totalUsers(u) }} users</span>
                      </div>
                      <div class="unit-body">
                        <div class="row">
                          <span class="badge admin">Admins</span>
                          <span class="pill admin" *ngFor="let a of u.unit_admins">{{ a.name }}</span>
                          <span class="pill muted" *ngIf="!u.unit_admins.length">None</span>
                        </div>
                        <div class="row">
                          <span class="badge std">Standards</span>
                          <span class="pill std" *ngFor="let s of u.standards">{{ s.name }}</span>
                          <span class="pill muted" *ngIf="!u.standards.length">None</span>
                        </div>
                      </div>
                    </div>
                  </li>
                </ul>

              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </div>

</div>
