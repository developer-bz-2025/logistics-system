<app-structure-tree-vertical></app-structure-tree-vertical>


<div class="max-w-7xl mx-auto p-6 space-y-8">
  <!-- A) CHORD / RIBBONS -->
  <div class="rounded-2xl border bg-white shadow-sm overflow-hidden">
    <div class="px-5 py-4 border-b flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl bg-indigo-50 border flex items-center justify-center text-indigo-600 text-lg">🧭
        </div>
        <div>
          <div class="font-semibold tracking-tight">Countries ↔ Entities (Ribbons)</div>
          <div class="text-xs text-gray-500">Curved ribbons show many-to-many; thickness = #units</div>
        </div>
      </div>
    </div>

    <div class="p-4 overflow-x-auto">
      <svg [attr.viewBox]="'0 0 ' + chordW + ' ' + chordH" class="w-full h-auto">
        <!-- links -->
        <g>
          <ng-container *ngFor="let l of linksChordDemo">
            <ng-container *ngIf="chordCountryIndexById(l.country_id) as li">
              <ng-container *ngIf="chordEntityIndexById(l.entity_id) as ri">
                <ng-container *ngIf="li >= 0 && ri >= 0">
                  <ng-container *ngIf="chordPosLeft(li) as L">
                    <ng-container *ngIf="chordPosRight(ri) as R">
                      <path [attr.d]="chordLinkPath(L.x, L.y, R.x, R.y)"
                        [attr.stroke]="chordColorForCountry(l.country_id)" [attr.stroke-width]="chordStrokeFor(l.units)"
                        [attr.opacity]="chordIsDimmed(l) ? 0.15 : 0.35" fill="none"
                        class="transition-opacity duration-150">
                      </path>
                    </ng-container>
                  </ng-container>
                </ng-container>
              </ng-container>
            </ng-container>
          </ng-container>
        </g>

        <!-- countries (left arc) -->
        <g>
          <ng-container *ngFor="let c of countriesChordDemo; let i = index">
            <ng-container *ngIf="chordPosLeft(i) as P">
              <circle [attr.cx]="P.x" [attr.cy]="P.y" r="9" [attr.fill]="c.color"
                (mouseenter)="setChordHoverCountry(c.id)" (mouseleave)="setChordHoverCountry(null)"></circle>
              <text [attr.x]="P.x - 12" [attr.y]="P.y" text-anchor="end" dominant-baseline="middle"
                class="fill-gray-700 text-sm select-none" (mouseenter)="setChordHoverCountry(c.id)"
                (mouseleave)="setChordHoverCountry(null)">
                {{ c.name }}
              </text>
            </ng-container>
          </ng-container>
        </g>

        <!-- entities (right arc) -->
        <g>
          <ng-container *ngFor="let e of entitiesChordDemo; let j = index">
            <ng-container *ngIf="chordPosRight(j) as P">
              <circle [attr.cx]="P.x" [attr.cy]="P.y" r="9" [attr.fill]="e.color"
                (mouseenter)="setChordHoverEntity(e.id)" (mouseleave)="setChordHoverEntity(null)"></circle>
              <text [attr.x]="P.x + 12" [attr.y]="P.y" text-anchor="start" dominant-baseline="middle"
                class="fill-gray-700 text-sm select-none" (mouseenter)="setChordHoverEntity(e.id)"
                (mouseleave)="setChordHoverEntity(null)">
                {{ e.name }}
              </text>
            </ng-container>
          </ng-container>
        </g>
      </svg>

      <div class="mt-3 grid grid-cols-1 md:grid-cols"></div><!-- WIDGET 1: Bubble Matrix -->
      <div class="rounded-2xl border bg-white shadow-sm overflow-hidden mb-8">
        <div class="px-5 py-4 border-b flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div
              class="h-9 w-9 rounded-xl bg-indigo-50 border flex items-center justify-center text-indigo-600 text-lg">🫧
            </div>
            <div>
              <div class="font-semibold">Countries × Entities (Bubble matrix)</div>
              <div class="text-xs text-gray-500">Circle size = number of units in that relationship</div>
            </div>
          </div>
        </div>

        <div class="p-4 md:p-6">
          <div class="w-full overflow-x-auto">
            <table class="min-w-[640px] w-full">
              <thead>
                <tr>
                  <th class="text-left text-xs font-semibold text-gray-500 px-2 py-1 sticky left-0 bg-white z-10">
                    Country</th>
                  <th *ngFor="let e of bubbleEntities" class="text-left text-xs font-semibold text-gray-500 px-2 py-1">
                    {{ e.name }}
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let c of bubbleCountries; let ri = index" (mouseenter)="bubbleHoverRow=ri"
                  (mouseleave)="bubbleHoverRow=-1">
                  <td class="sticky left-0 bg-white text-sm text-gray-700 px-2 py-2 pr-4 whitespace-nowrap z-10">
                    {{ c.name }}
                  </td>
                  <!-- <td *ngFor="let e of bubbleEntities; let ci = index" class="px-2 py-2"
                    (mouseenter)="bubbleHoverCol=ci" (mouseleave)="bubbleHoverCol=-1">
                    <div class="h-14 flex items-center justify-center">
                      <svg viewBox="0 0 40 40" class="h-10 w-10" [attr.title]="bubbleCellTitle(ri, ci)">
                        <circle cx="20" cy="20" [attr.r]="bubbleRadius(bubbleGrid[ri][ci])"
                          [attr.fill]="(bubbleHoverRow===ri || bubbleHoverCol===ci) ? '#6366F1' : '#A5B4FC'"
                          [attr.fill-opacity]="(bubbleGrid[ri][ci] ? 0.9 : 0.25)"></circle>
                        <text x="20" y="23" text-anchor="middle" class="text-[10px] fill-white"
                          *ngIf="bubbleGrid[ri][ci] >= (bubbleMax * 0.35)">
                          {{ bubbleGrid[ri][ci] }}
                        </text>
                      </svg>
                    </div>
                  </td> -->
                </tr>
              </tbody>
            </table>

            <div class="mt-3 flex items-center gap-2 text-xs text-gray-600">
              <span>Fewer</span>
              <div class="h-3 w-36 rounded-full bg-gradient-to-r from-indigo-200 via-indigo-400 to-indigo-700"></div>
              <span>More</span>
            </div>
          </div>
        </div>
      </div>

      <!-- WIDGET 2: Subway Map -->
      <div class="rounded-2xl border bg-white shadow-sm overflow-hidden mb-8">
        <div class="px-5 py-4 border-b flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div
              class="h-9 w-9 rounded-xl bg-emerald-50 border flex items-center justify-center text-emerald-600 text-lg">
              🧭</div>
            <div>
              <div class="font-semibold">Entities as stations (country lines)</div>
              <div class="text-xs text-gray-500">Each colored line is a country; stops are entities present in that
                country</div>
            </div>
          </div>
        </div>

        <div class="p-5">
          <div class="w-full overflow-x-auto">
            <svg [attr.viewBox]="'0 0 ' + subwayW + ' ' + subwayH" class="w-full h-auto">
              <!-- entity station labels -->
              <g>
                <ng-container *ngFor="let e of subwayEntities; let j = index">
                  <text [attr.x]="subwayXForStation(j)" [attr.y]="subwayPadY - 12" text-anchor="middle"
                    class="fill-gray-700 text-sm select-none">
                    {{ e.name }}
                  </text>
                </ng-container>
              </g>

              <!-- country lines -->
              <g>
                <ng-container *ngFor="let c of subwayCountries; let i = index">
                  <!-- label -->
                  <text [attr.x]="16" [attr.y]="subwayYForLine(i) + 4"
                    class="fill-gray-700 text-sm select-none cursor-pointer" (mouseenter)="subwayHoverCountryId=c.id"
                    (mouseleave)="subwayHoverCountryId=null">
                    {{ c.name }}
                  </text>

                  <!-- polyline through stations where this country has that entity -->
                  <!-- <polyline
                [attr.points]="subwayStationsForCountry(c.id).map(idx => (subwayXForStation(idx) + ',' + subwayYForLine(i))).join(' ')"
                [attr.stroke]="c.color"
                [attr.stroke-width]="subwayHoverCountryId===c.id ? 6 : 3.5"
                [attr.opacity]="subwayHoverCountryId && subwayHoverCountryId!==c.id ? 0.25 : 0.8"
                fill="none"
                stroke-linecap="round"
                stroke-linejoin="round" /> -->
                  <polyline [attr.points]="subwayPointsForCountry(c.id, i)" [attr.stroke]="c.color"
                    [attr.stroke-width]="subwayHoverCountryId===c.id ? 6 : 3.5"
                    [attr.opacity]="subwayHoverCountryId && subwayHoverCountryId!==c.id ? 0.25 : 0.8" fill="none"
                    stroke-linecap="round" stroke-linejoin="round">
                  </polyline>

                  <!-- station dots -->
                  <ng-container *ngFor="let e of subwayEntities; let j = index">
                    <ng-container *ngIf="subwayUnitsAt(c.id, e.id) as u">
                      <circle *ngIf="u>0" [attr.cx]="subwayXForStation(j)" [attr.cy]="subwayYForLine(i)"
                        [attr.r]="subwayDotR(u)" [attr.fill]="c.color"
                        [attr.opacity]="subwayHoverCountryId && subwayHoverCountryId!==c.id ? 0.25 : 1">
                      </circle>
                    </ng-container>
                  </ng-container>
                </ng-container>
              </g>
            </svg>
          </div>

          <div class="mt-3 text-xs text-gray-600">
            Hover a country name to highlight its route; dot size reflects units in that entity for the country.
          </div>
        </div>
      </div>


      <!-- WIDGET 3: Drilldown Explorer -->
      <div class="rounded-2xl border bg-white shadow-sm overflow-hidden mb-8">
        <div class="px-5 py-4 border-b flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-xl bg-amber-50 border flex items-center justify-center text-amber-600 text-lg">
              🧭</div>
            <div>
              <div class="font-semibold">Explore by Country → Entity</div>
              <div class="text-xs text-gray-500">Pick a country to see its entities; click a card for details</div>
            </div>
          </div>
        </div>

        <div class="p-5 space-y-5">
          <!-- Country chips -->
          <div class="flex flex-wrap gap-2">
            <button *ngFor="let c of drillCountries" class="px-3 py-1.5 rounded-full border text-sm"
              [ngClass]="drillSelectedCountryId===c.id ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white hover:bg-gray-50'"
              (click)="drillSelectedCountryId = (drillSelectedCountryId===c.id ? null : c.id); drillSelectedEntityId = null;">
              {{ c.name }}
            </button>
          </div>

          <!-- Entity cards for the selected country -->
          <ng-container *ngIf="drillSelectedCountryId as cid">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
              <div *ngFor="let e of drillEntitiesForCountry(cid)"
                class="rounded-xl border p-4 hover:shadow-sm transition cursor-pointer"
                [ngClass]="drillSelectedEntityId===e.id ? 'ring-2 ring-indigo-500' : ''"
                (click)="drillSelectedEntityId = (drillSelectedEntityId===e.id ? null : e.id)">
                <div class="text-sm font-semibold">{{ e.name }}</div>
                <div class="text-xs text-gray-500 mt-1">Units linked: <span class="font-medium text-gray-700">{{ e.units
                    }}</span></div>
              </div>
            </div>
          </ng-container>

          <!-- Summary panel -->
          <div class="rounded-xl border bg-gray-50 p-4" *ngIf="drillSelectedCountryId && drillSelectedEntityId">
            <div class="font-medium mb-1">
              {{ drillCountryName(drillSelectedCountryId) }} × {{ drillEntityName(drillSelectedEntityId) }}

              <!-- {{ drillCountries.find(x=>x.id===drillSelectedCountryId)?.name }} ×
              {{ drillEntities.find(x=>x.id===drillSelectedEntityId)?.name }} -->
            </div>
            <div class="text-sm text-gray-600">
              Units in this relationship:
              <span class="font-semibold text-gray-800">
                {{ drillUnitsCount(drillSelectedCountryId, drillSelectedEntityId) }}
              </span>
            </div>
            <div class="text-xs text-gray-500 mt-1">
              Tip: In the real app, clicking here could open the filtered Browse view for this scope.
            </div>
          </div>
        </div>
      </div>


      <div class="rounded-2xl border bg-white shadow-sm overflow-hidden">
        <!-- Header with global roles -->
        <div class="px-5 py-4 border-b flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-xl bg-indigo-50 border flex items-center justify-center text-indigo-600 text-lg">🧭</div>
            <div>
              <div class="font-semibold tracking-tight">How we’re organized</div>
              <div class="text-xs text-gray-500">Countries → Entities → Units. Roles shown at each level.</div>
            </div>
          </div>
      
          <!-- Global roles -->
          <div class="hidden md:flex items-center gap-2">
            <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full text-xs border"
                  [ngClass]="[roleChips.super_admin.bg, roleChips.super_admin.fg, roleChips.super_admin.br]">
              {{ roleChips.super_admin.icon }} {{ roleChips.super_admin.text }}
            </span>
            <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full text-xs border"
                  [ngClass]="[roleChips.c_level.bg, roleChips.c_level.fg, roleChips.c_level.br]">
              {{ roleChips.c_level.icon }} {{ roleChips.c_level.text }}
            </span>
          </div>
        </div>
      
        <!-- Body -->
        <div class="p-5">
          <div class="space-y-4">
            <!-- Countries -->
            <div *ngFor="let c of countries" class="rounded-xl border">
              <!-- Country header -->
              <button class="w-full flex items-center justify-between px-4 py-3 text-left hover:bg-gray-50"
                      (click)="toggleCountry(c.id)">
                <div class="flex items-center gap-3">
                  <span class="inline-flex h-7 w-7 items-center justify-center rounded-lg bg-indigo-50 border text-indigo-600">🌍</span>
                  <div>
                    <div class="font-medium">{{ c.name }}</div>
                    <div class="text-xs text-gray-500">Country</div>
                  </div>
                  <!-- Country role -->
                  <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-[11px] border"
                        [ngClass]="[roleChips.country_dir.bg, roleChips.country_dir.fg, roleChips.country_dir.br]">
                    {{ roleChips.country_dir.icon }} {{ roleChips.country_dir.text }}
                  </span>
                </div>
                <div class="text-gray-400">{{ expandedCountries.has(c.id) ? '▾' : '▸' }}</div>
              </button>
      
              <!-- Entities within country -->
              <div *ngIf="expandedCountries.has(c.id)" class="px-4 pb-4">
                <div class="border-l ml-3 pl-5 space-y-3">
                  <div *ngFor="let e of c.entities" class="rounded-lg border">
                    <button class="w-full flex items-center justify-between px-3 py-2 text-left hover:bg-gray-50"
                            (click)="toggleEntity(c.id, e.id)">
                      <div class="flex items-center gap-3">
                        <span class="inline-flex h-6 w-6 items-center justify-center rounded-md bg-sky-50 border text-sky-600">🏢</span>
                        <div>
                          <div class="font-medium">{{ e.name }}</div>
                          <div class="text-[11px] text-gray-500">
                            Entity • {{ unitCount(e) }} units • {{ usersSum(e) }} users
                            <!-- <span *ngIf="e.alsoIn?.length" class="text-gray-400"> (also in {{ e.alsoIn.join(', ') }})</span> -->
                          </div>
                        </div>
                        <!-- Entity role -->
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] border"
                              [ngClass]="[roleChips.head_of_entity.bg, roleChips.head_of_entity.fg, roleChips.head_of_entity.br]">
                          {{ roleChips.head_of_entity.icon }} {{ roleChips.head_of_entity.text }}
                        </span>
                      </div>
                      <div class="text-gray-400">{{ isEntityOpen(c.id,e.id) ? '▾' : '▸' }}</div>
                    </button>
      
                    <!-- Units -->
                    <div *ngIf="isEntityOpen(c.id, e.id)" class="px-3 pb-3">
                      <div class="border-l ml-2 pl-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                        <div *ngFor="let u of e.units" class="rounded-lg border p-3 bg-white">
                          <div class="flex items-center justify-between">
                            <div class="font-medium">{{ u.name }}</div>
                            <div class="text-xs text-gray-500">{{ u.users }} users</div>
                          </div>
                          <div class="mt-2 flex flex-wrap gap-1.5">
                            <!-- Unit Admin -->
                            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] border"
                                  [ngClass]="[roleChips.unit_admin.bg, roleChips.unit_admin.fg, roleChips.unit_admin.br]">
                              {{ roleChips.unit_admin.icon }} Unit Admin
                            </span>
                            <!-- Standard users -->
                            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] border"
                                  [ngClass]="[roleChips.standard.bg, roleChips.standard.fg, roleChips.standard.br]">
                              {{ roleChips.standard.icon }} Standard
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <!-- /Units -->
                  </div>
                </div>
              </div>
              <!-- /Entities -->
            </div>
            <!-- /Countries -->
          </div>
      
          <!-- Footer hint -->
          <div class="mt-4 text-[11px] text-gray-500">
            Tip: In the live app, clicking a unit can deep-link to the Browse view filtered for that scope. Role rules still apply (C-level & Super Admin see across; Country Dir at country; Head of Entity at entity; Unit Admin & Standards in unit).
          </div>
        </div>
      </div>
      <!-- block 5  -->
      <div class="rounded-2xl border bg-white shadow-sm overflow-hidden">
        <!-- Header -->
        <div class="px-5 py-4 border-b flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-xl bg-indigo-50 border flex items-center justify-center text-indigo-600 text-lg">🧭</div>
            <div>
              <div class="font-semibold tracking-tight">Organization Explorer</div>
              <div class="text-xs text-gray-500">Horizontal view — Countries → Entities → Units, click role chips to show names</div>
            </div>
          </div>
          <!-- Global roles (always visible) -->
          <div class="hidden md:flex items-center gap-2">
            <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full text-xs border bg-amber-50 text-amber-700 border-amber-200">
              🧑‍💼👑 Super Admin
            </span>
            <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full text-xs border bg-violet-50 text-violet-700 border-violet-200">
              🧑‍💼🏛️ C-level
            </span>
          </div>
        </div>
      
        <!-- Body: 4 columns -->
        <div class="p-5">
          <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
      
            <!-- Col 1: Countries -->
            <div class="rounded-xl border">
              <div class="px-3 py-2 border-b text-xs font-semibold text-gray-500">Countries</div>
              <div class="p-3 space-y-2 max-h-[420px] overflow-auto">
                <div *ngFor="let c of hxCountries"
                     class="rounded-lg border p-3 cursor-pointer transition"
                     [ngClass]="hxSelectedCountryId===c.id ? 'ring-2 ring-indigo-500 bg-indigo-50/40' : 'hover:bg-gray-50'"
                     (click)="hxSelectCountry(c.id)">
                  <div class="flex items-center justify-between">
                    <div class="font-medium">{{ c.name }}</div>
                    <!-- Country Dir chip -->
                    <button type="button"
                      class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] border"
                      [ngClass]="[hxChip('country_dir').bg, hxChip('country_dir').fg, hxChip('country_dir').br]"
                      (click)="$event.stopPropagation(); hxToggleCountryDir(c.id)">
                      {{ hxChip('country_dir').icon }} Country Dir
                    </button>
                  </div>
                  <!-- Reveal names -->
                  <div *ngIf="hxOpenCountryDir.has(c.id)" class="mt-2 flex flex-wrap gap-1.5">
                    <span *ngFor="let n of c.country_dirs"
                          class="px-2 py-0.5 rounded-full text-[11px] bg-white border">
                      {{ n }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
      
            <!-- Col 2: Entities (for selected country) -->
            <div class="rounded-xl border">
              <div class="px-3 py-2 border-b text-xs font-semibold text-gray-500">Entities in {{ hxCountryById(hxSelectedCountryId)?.name || '—' }}</div>
              <div class="p-3 space-y-2 max-h-[420px] overflow-auto">
                <div *ngFor="let e of hxEntitiesForCountry(hxSelectedCountryId)"
                     class="rounded-lg border p-3 cursor-pointer transition"
                     [ngClass]="hxSelectedEntityId===e.id ? 'ring-2 ring-sky-500 bg-sky-50/40' : 'hover:bg-gray-50'"
                     (click)="hxSelectEntity(e.id)">
                  <div class="flex items-center justify-between">
                    <div class="font-medium">{{ e.name }}</div>
                    <!-- Head of Entity chip -->
                    <button type="button"
                      class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] border"
                      [ngClass]="[hxChip('head_of_entity').bg, hxChip('head_of_entity').fg, hxChip('head_of_entity').br]"
                      (click)="$event.stopPropagation(); hxToggleEntityHeads(hxSelectedCountryId!, e.id)">
                      {{ hxChip('head_of_entity').icon }} Head
                    </button>
                  </div>
                  <!-- Reveal names -->
                  <div *ngIf="hxOpenEntityHeads.has(hxEntityKey(hxSelectedCountryId!, e.id))" class="mt-2 flex flex-wrap gap-1.5">
                    <span *ngFor="let n of e.heads"
                          class="px-2 py-0.5 rounded-full text-[11px] bg-white border">
                      {{ n }}
                    </span>
                  </div>
                  <div class="text-[11px] text-gray-500 mt-1">{{ e.units.length }} units</div>
                </div>
              </div>
            </div>
      
            <!-- Col 3: Units -->
            <div class="rounded-xl border">
              <div class="px-3 py-2 border-b text-xs font-semibold text-gray-500">Units in {{ hxEntityByIds(hxSelectedCountryId, hxSelectedEntityId)?.name || '—' }}</div>
              <div class="p-3 space-y-2 max-h-[420px] overflow-auto">
                <div *ngFor="let u of hxUnitsForSelection()" class="rounded-lg border p-3 bg-white">
                  <div class="flex items-center justify-between">
                    <div class="font-medium">{{ u.name }}</div>
                  </div>
                  <div class="mt-2 flex flex-wrap gap-1.5">
                    <!-- Unit Admin chip -->
                    <button type="button"
                            class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] border"
                            [ngClass]="[hxChip('unit_admin').bg, hxChip('unit_admin').fg, hxChip('unit_admin').br]"
                            (click)="hxToggleUnitAdmins(u.id)">
                      {{ hxChip('unit_admin').icon }} Admins ({{ u.unit_admins.length }})
                    </button>
                    <!-- Standards chip -->
                    <button type="button"
                            class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] border"
                            [ngClass]="[hxChip('standard').bg, hxChip('standard').fg, hxChip('standard').br]"
                            (click)="hxToggleUnitStandards(u.id)">
                      {{ hxChip('standard').icon }} Standards ({{ u.standards.length }})
                    </button>
                  </div>
      
                  <!-- Reveal admin names -->
                  <div *ngIf="hxOpenUnitAdmins.has(u.id)" class="mt-2 flex flex-wrap gap-1.5">
                    <span *ngFor="let n of u.unit_admins"
                          class="px-2 py-0.5 rounded-full text-[11px] bg-emerald-50 border border-emerald-200 text-emerald-700">
                      {{ n }}
                    </span>
                  </div>
      
                  <!-- Reveal standard users -->
                  <div *ngIf="hxOpenUnitStandards.has(u.id)" class="mt-2 flex flex-wrap gap-1.5">
                    <span *ngFor="let n of u.standards"
                          class="px-2 py-0.5 rounded-full text-[11px] bg-slate-100 border border-slate-200 text-slate-700">
                      {{ n }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
      
            <!-- Col 4: Selection summary / Tips -->
            <div class="rounded-xl border bg-gray-50">
              <div class="px-3 py-2 border-b text-xs font-semibold text-gray-500">Selection</div>
              <div class="p-3 space-y-3">
                <div>
                  <div class="text-xs text-gray-500">Country</div>
                  <div class="font-medium">{{ hxCountryById(hxSelectedCountryId)?.name || '—' }}</div>
                </div>
                <div>
                  <div class="text-xs text-gray-500">Entity</div>
                  <div class="font-medium">{{ hxEntityByIds(hxSelectedCountryId, hxSelectedEntityId)?.name || '—' }}</div>
                </div>
                <div class="text-xs text-gray-500 pt-2 border-t">
                  Tip: In the real app, clicking a unit could jump to Browse with scope filters applied and role-based visibility enforced.
                </div>
                <div class="pt-3">
                  <div class="text-xs text-gray-500 mb-1">Global roles</div>
                  <div class="flex flex-wrap gap-1.5">
                    <span class="px-2 py-0.5 rounded-full text-[11px] bg-amber-50 border border-amber-200 text-amber-700">🧑‍💼👑 {{ hxSuperAdmins.join(', ') }}</span>
                    <span class="px-2 py-0.5 rounded-full text-[11px] bg-violet-50 border border-violet-200 text-violet-700">🧑‍💼🏛️ {{ hxCLevels.join(', ') }}</span>
                  </div>
                </div>
              </div>
            </div>
      
          </div>
        </div>
      </div>

      <!-- block 6 -->
      <div class="rounded-2xl border bg-white shadow-sm overflow-hidden">
        <!-- Header -->
        <div class="px-5 py-4 border-b flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-xl bg-indigo-50 border flex items-center justify-center text-indigo-600 text-lg">🧭</div>
            <div>
              <div class="font-semibold tracking-tight">Organization (Vertical Explorer)</div>
              <div class="text-xs text-gray-500">Top → bottom: Countries → Entities → Units. Click chips to show names.</div>
            </div>
          </div>
          <div class="hidden md:flex items-center gap-2">
            <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full text-xs border bg-amber-50 text-amber-700 border-amber-200">
              🧑‍💼👑 Super Admin
            </span>
            <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full text-xs border bg-violet-50 text-violet-700 border-violet-200">
              🧑‍💼🏛️ C-level
            </span>
          </div>
        </div>
      
        <!-- Body -->
        <div class="p-5 space-y-4">
          <!-- Countries -->
          <div *ngFor="let c of vxCountries" class="rounded-xl border">
            <!-- Country header -->
            <div class="flex items-center justify-between px-4 py-3">
              <div class="flex items-center gap-3">
                <span class="inline-flex h-7 w-7 items-center justify-center rounded-lg bg-indigo-50 border text-indigo-600">🌍</span>
                <div>
                  <div class="font-medium">{{ c.name }}</div>
                  <div class="text-xs text-gray-500">Country</div>
                </div>
                <!-- Country Dir chip -->
                <button type="button"
                        class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] border"
                        [ngClass]="[vxChip('country_dir').bg, vxChip('country_dir').fg, vxChip('country_dir').br]"
                        (click)="vxToggleCountryDir(c.id)">
                  {{ vxChip('country_dir').icon }} Country Dir
                </button>
                <div *ngIf="vxOpenCountryDir.has(c.id)" class="flex flex-wrap gap-1.5 ml-1">
                  <span *ngFor="let n of c.country_dirs" class="px-2 py-0.5 rounded-full text-[11px] bg-white border">{{ n }}</span>
                </div>
              </div>
      
              <button class="text-sm text-gray-600 px-3 py-1 rounded-lg border hover:bg-gray-50"
                      (click)="vxToggleCountry(c.id)">
                {{ vxExpandedCountries.has(c.id) ? 'Collapse' : 'Expand' }}
              </button>
            </div>
      
            <!-- Entities -->
            <div *ngIf="vxExpandedCountries.has(c.id)" class="px-4 pb-4">
              <div class="border-l ml-3 pl-5 space-y-3">
                <div *ngFor="let e of c.entities" class="rounded-lg border">
                  <div class="flex items-center justify-between px-3 py-2">
                    <div class="flex items-center gap-3">
                      <span class="inline-flex h-6 w-6 items-center justify-center rounded-md bg-sky-50 border text-sky-600">🏢</span>
                      <div>
                        <div class="font-medium">{{ e.name }}</div>
                        <div class="text-[11px] text-gray-500">Entity • {{ vxUnitCount(e) }} units • {{ vxUsersSum(e) }} users</div>
                      </div>
                      <!-- Head of Entity chip -->
                      <button type="button"
                              class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] border"
                              [ngClass]="[vxChip('head_of_entity').bg, vxChip('head_of_entity').fg, vxChip('head_of_entity').br]"
                              (click)="vxToggleEntityHeads(c.id, e.id)">
                        {{ vxChip('head_of_entity').icon }} Head
                      </button>
                      <div *ngIf="vxOpenEntityHeads.has(vxEntityKey(c.id, e.id))" class="flex flex-wrap gap-1.5 ml-1">
                        <span *ngFor="let n of e.heads" class="px-2 py-0.5 rounded-full text-[11px] bg-white border">{{ n }}</span>
                      </div>
                    </div>
      
                    <button class="text-sm text-gray-600 px-3 py-1 rounded-lg border hover:bg-gray-50"
                            (click)="vxToggleEntity(c.id, e.id)">
                      {{ vxIsEntityOpen(c.id, e.id) ? 'Hide units' : 'Show units' }}
                    </button>
                  </div>
      
                  <!-- Units -->
                  <div *ngIf="vxIsEntityOpen(c.id, e.id)" class="px-3 pb-3">
                    <div class="border-l ml-2 pl-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                      <div *ngFor="let u of e.units" class="rounded-lg border p-3 bg-white">
                        <div class="flex items-center justify-between">
                          <div class="font-medium">{{ u.name }}</div>
                          <div class="text-xs text-gray-500">
                            {{ u.unit_admins.length + u.standards.length }} users
                          </div>
                        </div>
      
                        <div class="mt-2 flex flex-wrap gap-1.5">
                          <!-- Unit Admin chip -->
                          <button type="button"
                                  class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] border"
                                  [ngClass]="[vxChip('unit_admin').bg, vxChip('unit_admin').fg, vxChip('unit_admin').br]"
                                  (click)="vxToggleUnitAdmins(u.id)">
                            {{ vxChip('unit_admin').icon }} Admins ({{ u.unit_admins.length }})
                          </button>
      
                          <!-- Standard users chip -->
                          <button type="button"
                                  class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] border"
                                  [ngClass]="[vxChip('standard').bg, vxChip('standard').fg, vxChip('standard').br]"
                                  (click)="vxToggleUnitStandards(u.id)">
                            {{ vxChip('standard').icon }} Standards ({{ u.standards.length }})
                          </button>
                        </div>
      
                        <!-- Names lists -->
                        <div *ngIf="vxOpenUnitAdmins.has(u.id)" class="mt-2 flex flex-wrap gap-1.5">
                          <span *ngFor="let n of u.unit_admins"
                                class="px-2 py-0.5 rounded-full text-[11px] bg-emerald-50 border border-emerald-200 text-emerald-700">
                            {{ n }}
                          </span>
                        </div>
      
                        <div *ngIf="vxOpenUnitStandards.has(u.id)" class="mt-2 flex flex-wrap gap-1.5">
                          <span *ngFor="let n of u.standards"
                                class="px-2 py-0.5 rounded-full text-[11px] bg-slate-100 border border-slate-200 text-slate-700">
                            {{ n }}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- /Units -->
                </div>
              </div>
            </div>
            <!-- /Entities -->
          </div>
        </div>
      </div>
      