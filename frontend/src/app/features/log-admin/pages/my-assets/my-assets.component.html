<div class="my-assets-page">
  <header class="page-header">
    <div>
      <h1>My Assets</h1>
      <p>Assets located in sites you manage. Use filters to drill down quickly.</p>
    </div>
  </header>

  <mat-card class="filters-card">
    <form [formGroup]="form" (ngSubmit)="applySearch()">
      <div class="filter-grid">
        <mat-form-field appearance="outline">
          <mat-label>Search by name or serial</mat-label>
          <input matInput formControlName="search" placeholder="Search..." (keyup.enter)="applySearch()" />
          <button
            mat-icon-button
            matSuffix
            type="button"
            aria-label="Clear search"
            *ngIf="form.value.search"
            (click)="form.patchValue({ search: '' }); applySearch()"
          >
            <mat-icon>close</mat-icon>
          </button>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Status</mat-label>
          <mat-select formControlName="status_id">
            <mat-option [value]="null">All statuses</mat-option>
            <mat-option *ngFor="let status of statuses" [value]="status.id">
              {{ status.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Sort by</mat-label>
          <mat-select formControlName="sort">
            <mat-option value="acquisition_date">Acquisition date</mat-option>
            <mat-option value="created_at">Created date</mat-option>
            <mat-option value="sn">Serial number</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Direction</mat-label>
          <mat-select formControlName="dir">
            <mat-option value="desc">Descending</mat-option>
            <mat-option value="asc">Ascending</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="filter-actions">
        <button mat-stroked-button type="button" (click)="clearFilters()">Reset</button>
        <button mat-flat-button color="primary" type="submit">Apply</button>
      </div>
    </form>
  </mat-card>

  <div class="app-card table-card">
    <div *ngIf="loading" class="mb-4">
      <div class="w-full bg-gray-200 rounded-full h-2">
        <div class="bg-green-500 h-2 rounded-full animate-pulse" style="width: 100%"></div>
      </div>
      <p class="text-sm text-gray-600 mt-2">Loading assets...</p>
    </div>

    <div class="table-header">
      <div>
        <h2 class="text-xl font-semibold">Results</h2>
        <p class="text-gray-500">{{ total }} assets found</p>
      </div>
    </div>

    <div class="table-wrapper">
      <div *ngIf="!loading && data.length === 0" class="empty-state">
        <mat-icon>inventory_2</mat-icon>
        <p>No assets found for your locations with the current filters.</p>
      </div>

      <table *ngIf="!loading && data.length" mat-table [dataSource]="data" class="mat-elevation-z0 my-assets-table">
        <ng-container matColumnDef="sn">
          <th mat-header-cell *matHeaderCellDef>Serial</th>
          <td mat-cell *matCellDef="let asset">{{ asset.sn || '—' }}</td>
        </ng-container>

        <ng-container matColumnDef="fixed_item">
          <th mat-header-cell *matHeaderCellDef>Item</th>
          <td mat-cell *matCellDef="let asset">
            <div class="asset-name">{{ asset.fixed_item_name || asset.fixed_item || 'Asset #' + asset.id }}</div>
            <div class="asset-fixed-item">{{ asset.fixed_item }}</div>
          </td>
        </ng-container>

        <ng-container matColumnDef="acquisition_date">
          <th mat-header-cell *matHeaderCellDef>Acquired</th>
          <td mat-cell *matCellDef="let asset">{{ asset.acquisition_date | date : 'mediumDate' }}</td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let asset">
            <span
              class="status-chip"
              [ngClass]="{
                'bg-green-200 text-green-800': asset.status_name === 'Functional' || asset.status_name === 'New',
                'bg-yellow-100 text-yellow-800': asset.status_name === 'In Storage',
                'bg-red-100 text-red-800': asset.status_name === 'Damaged' || asset.status_name === 'Lost' || asset.status_name === 'Stolen',
                'bg-blue-100 text-blue-800': asset.status_name === 'Donated' || asset.status_name === 'Transferred',
                'bg-gray-100 text-gray-800': asset.status_name === 'Under Maintenance',
                'bg-green-100 text-gray-800': !asset.status_name
              }"
            >
              {{ asset.status_name || 'Unknown' }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="location">
          <th mat-header-cell *matHeaderCellDef>Location</th>
          <td mat-cell *matCellDef="let asset">
            <span
              class="location-chip"
              [ngClass]="{
                'bg-blue-100 text-blue-800': asset.location_name === 'HQ',
                'bg-green-100 text-green-800': asset.location_name === 'Bekaa',
                'bg-yellow-100 text-yellow-800': asset.location_name === 'Shatila',
                'bg-purple-100 text-purple-800': asset.location_name === 'Nabaa',
                'bg-pink-100 text-pink-800': asset.location_name === 'Burj',
                'bg-indigo-100 text-indigo-800': asset.location_name === 'Tripoli',
                'bg-orange-100 text-orange-800': asset.location_name === 'Akkar',
                'bg-green-100 text-gray-800': !asset.location_name
              }"
            >
              {{ asset.location_name || '—' }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="brand">
          <th mat-header-cell *matHeaderCellDef>Brand</th>
          <td mat-cell *matCellDef="let asset">{{ asset.brand_name || '—' }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayedColumns"
          class="cursor-pointer hover:bg-gray-50"
          (click)="navigateToAsset(row)"
        ></tr>
      </table>
    </div>

    <mat-paginator
      [length]="total"
      [pageSize]="form.value.per_page || 10"
      [pageSizeOptions]="[10, 25, 50]"
      (page)="pageChange($event)"
      showFirstLastButtons
    ></mat-paginator>
  </div>
</div>

