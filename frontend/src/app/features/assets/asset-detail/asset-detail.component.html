<div class="asset-detail-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-card">
      <mat-spinner diameter="50" color="primary"></mat-spinner>
      <h3>Loading asset details...</h3>
      <p>Please wait while we fetch the information</p>
    </div>
  </div>

  <!-- Asset Details -->
  <div *ngIf="!isLoading && asset" class="asset-detail-content app-card">
    <!-- Header Section -->
    <div class="header-section">
      <div class="header-content">
        <button mat-icon-button (click)="goBack()" class="back-button" matTooltip="Back to assets list">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div class="title-section">
          <div class="asset-badge">
            <mat-icon class="asset-icon">inventory_2</mat-icon>
            <span class="asset-type">{{ asset.category_name }}</span>
          </div>
          <h1 class="asset-title">{{ asset.fixed_item_name }}</h1>
          <p class="asset-subtitle">{{ asset.sn || 'Asset #' + asset.id }}</p>
        </div>
        <div class="status-section">
          <div class="status-chip" [ngClass]="getStatusClass(asset.status_name)">
            <mat-icon class="status-icon">{{ getStatusIcon(asset.status_name) }}</mat-icon>
            <span>{{ asset.status_name || 'Unknown' }}</span>
          </div>
        </div>
      </div>

      <div class="action-buttons">
        <ng-container *ngIf="!isEditing; else editActions">
          <button
          mat-stroked-button
          color="primary"
          class="move-button"
          (click)="openMoveAssetDialog()"
          [disabled]="!canEditAsset || !allowedMoveLocations.length || isRelocating">
          <mat-icon>swap_horiz</mat-icon>
          <span>{{ isRelocating ? 'Moving...' : 'Move Asset' }}</span>
        </button>
          <button
            mat-raised-button
            color="primary"
            (click)="toggleEdit()"
            class="edit-button"
            [disabled]="!canEditAsset">
            <mat-icon>edit</mat-icon>
            <span>Edit Asset</span>
          </button>
        
        </ng-container>
        <ng-template #editActions>
          <button
            mat-stroked-button
            (click)="toggleEdit()"
            class="cancel-button">
            <mat-icon>cancel</mat-icon>
            <span>Cancel</span>
          </button>
          <button
            mat-raised-button
            color="primary"
            (click)="saveAsset()"
            [disabled]="assetForm.invalid || isSaving"
            class="save-button">
            <mat-icon *ngIf="!isSaving">save</mat-icon>
            <mat-spinner *ngIf="isSaving" diameter="20" color="accent"></mat-spinner>
            <span>{{ isSaving ? 'Saving...' : 'Save Changes' }}</span>
          </button>
        </ng-template>
      </div>
    </div>

    <!-- Asset Photo -->
    <div class="asset-photo-container">
      <div class="asset-photo" *ngIf="asset.photo_url; else placeholderPhoto" (click)="openPhotoPreview()">
        <img [src]="asset.photo_url" alt="Asset photo" />
        <div class="photo-overlay" *ngIf="canEditAsset">
          <button 
            mat-icon-button 
            class="photo-edit-btn"
            (click)="onPhotoEditClick($event)"
            [disabled]="isUploadingPhoto"
            matTooltip="Update photo">
            <mat-icon>{{ isUploadingPhoto ? 'hourglass_empty' : 'edit' }}</mat-icon>
          </button>
        </div>
        <div *ngIf="isUploadingPhoto" class="photo-upload-overlay">
          <mat-spinner diameter="40"></mat-spinner>
          <span>Uploading...</span>
        </div>
      </div>
      <ng-template #placeholderPhoto>
        <div class="asset-photo placeholder" [class.editable]="canEditAsset">
          <mat-icon>photo_camera</mat-icon>
          <span>No photo uploaded</span>
          <button 
            *ngIf="canEditAsset"
            mat-raised-button 
            color="primary"
            class="upload-photo-btn"
            (click)="onPhotoEditClick($event)"
            [disabled]="isUploadingPhoto">
            <mat-icon>add_photo_alternate</mat-icon>
            <span>Upload Photo</span>
          </button>
        </div>
      </ng-template>
    </div>

    <!-- Compact Information Display -->
    <div *ngIf="!isEditing" class="compact-info-section">
      <div class="info-table">
        <div class="info-row">
          <div class="info-cell">
            <mat-icon>tag</mat-icon>
            <div class="cell-content">
              <label>Serial Number</label>
              <span>{{ asset.sn || 'NA' }}</span>
            </div>
          </div>
          <div class="info-cell">
            <mat-icon>category</mat-icon>
            <div class="cell-content">
              <label>Category</label>
              <span>{{ asset.category_name }} > {{ asset.sub_category_name }}</span>
            </div>
          </div>
          <div class="info-cell">
            <mat-icon>place</mat-icon>
            <div class="cell-content">
              <label>Location</label>
              <span>{{ asset.location_name || 'Not assigned' }}</span>
            </div>
          </div>
        </div>

        <div class="info-row">
          <div class="info-cell">
            <mat-icon>description</mat-icon>
            <div class="cell-content">
              <label>Description</label>
              <span>{{ asset.description || 'No description available' }}</span>
            </div>
          </div>
          <div class="info-cell">
            <mat-icon>person</mat-icon>
            <div class="cell-content">
              <label>Current Holder</label>
              <span>{{ asset.holder_name || 'Not assigned' }}</span>
            </div>
          </div>
          <div class="info-cell">
            <mat-icon>attach_money</mat-icon>
            <div class="cell-content">
              <label>Acquisition Cost</label>
              <span class="cost-amount">{{ asset.acquisition_cost ? ('$' + asset.acquisition_cost) : 'Not specified' }}</span>
            </div>
          </div>
        </div>

        <div class="info-row">
          <div class="info-cell">
            <mat-icon>store</mat-icon>
            <div class="cell-content">
              <label>Supplier</label>
              <span>{{ asset.supplier_name || 'Not specified' }}</span>
            </div>
          </div>
          <div class="info-cell">
            <mat-icon>build</mat-icon>
            <div class="cell-content">
              <label>Brand</label>
              <span>{{ asset.brand_name || 'Not specified' }}</span>
            </div>
          </div>
          <div class="info-cell">
            <mat-icon>verified</mat-icon>
            <div class="cell-content">
              <label>Warranty</label>
              <span>{{ getWarrantyPeriod(asset) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Detailed Information -->
    <div *ngIf="!isEditing" class="details-section">
      <mat-card class="details-card">
        <mat-card-header>
          <mat-card-title>Detailed Information</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="details-grid">
            <!-- Specifications -->
            <div class="detail-group">
              <h3 class="group-title">
                <mat-icon>science</mat-icon>
                Specifications
              </h3>
              <div class="detail-items">
                <div class="detail-item">
                  <label>Color</label>
                  <span>{{ asset.color_name || 'Not specified' }}</span>
                </div>
                <div class="detail-item">
                  <label>PR</label>
                  <span>{{ prCode || 'Not specified' }}</span>
                </div>
                <div class="detail-item">
                  <label>Budget Donor</label>
                  <span>{{ asset.budget_donor || 'Not specified' }}</span>
                </div>
                <div class="detail-item">
                  <label>Budget Code</label>
                  <span>{{ asset.budget_code || 'Not specified' }}</span>
                </div>
                <div class="detail-item">
                  <label>Floor</label>
                  <span>{{ asset.floor_name || 'Not specified' }}</span>
                </div>
              </div>
            </div>

            <!-- Dynamic Attributes -->
            <div *ngIf="asset.attributes && getAttributeKeys(asset.attributes).length > 0" class="detail-group">
              <h3 class="group-title">
                <mat-icon>settings</mat-icon>
                Additional Attributes
              </h3>
              <div class="detail-items">
                <div *ngFor="let key of getAttributeKeys(asset.attributes)" class="detail-item">
                  <label>{{ getAttributeDisplayName(key) }}</label>
                  <span>{{ asset.attributes[key] || 'Not specified' }}</span>
                </div>
              </div>
            </div>

            <!-- Notes -->
            <div *ngIf="asset.notes" class="detail-group full-width">
              <h3 class="group-title">
                <mat-icon>notes</mat-icon>
                Notes
              </h3>
              <div class="notes-content">
                <p>{{ asset.notes }}</p>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Asset Lifecycle/History -->
    <div *ngIf="!isEditing" class="history-section">
      <mat-card class="history-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>history</mat-icon>
            Asset Lifecycle
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="historyLoading" class="history-loading">
            <mat-spinner diameter="30"></mat-spinner>
            <span>Loading history...</span>
          </div>

          <div *ngIf="!historyLoading && history.length === 0" class="history-empty">
            <mat-icon>info</mat-icon>
            <p>No history available for this asset.</p>
          </div>

          <div *ngIf="!historyLoading && history.length > 0" class="history-timeline">
            <div *ngFor="let event of history; let i = index" class="timeline-item">
              <div class="timeline-marker" [ngClass]="getEventColor(event.event_type)">
                <mat-icon>{{ getEventIcon(event.event_type) }}</mat-icon>
              </div>
              <div class="timeline-content">
                <div class="timeline-header">
                  <span class="event-summary">{{ event.summary }}</span>
                  <span class="event-date">{{ formatHistoryDate(event.occurred_at) }}</span>
                </div>
                <div class="timeline-user">
                  <mat-icon class="user-icon">person</mat-icon>
                  <span>{{ event.by_user?.name || 'Unknown' }}</span>
                  <span class="user-email">({{ event.by_user?.email || '' }})</span>
                </div>
                
                <!-- Location Change Details -->
                <div *ngIf="event.event_type === 'location_changed' && event.payload" class="event-details">
                  <div class="location-change">
                    <span class="old-location">{{ event.payload.old_location }}</span>
                    <mat-icon>arrow_forward</mat-icon>
                    <span class="new-location">{{ event.payload.new_location }}</span>
                  </div>
                </div>

                <!-- Update Changes Details -->
                <div *ngIf="event.event_type === 'updated' && event.payload?.changes?.changes" class="event-details update-details">
                  <div class="update-changes">
                    <div *ngFor="let field of event.payload.changes.changes" class="change-item">
                      <div class="change-field-name">{{ formatFieldName(field) }}</div>
                      <div class="change-values">
                        <span class="old-value">{{ formatFieldValue(event.payload.changes.old_values[field], field, event.payload.changes.old_values) }}</span>
                        <mat-icon class="change-arrow">arrow_forward</mat-icon>
                        <span class="new-value">{{ formatFieldValue(event.payload.changes.new_values[field], field, event.payload.changes.new_values) }}</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Location Change Request Details -->
                <div *ngIf="event.location_change_request" class="event-details request-details">
                  <div class="request-info">
                    <div class="request-locations">
                      <span class="label">From:</span>
                      <span>{{ event.location_change_request.current_location?.name }}</span>
                      <span class="label">To:</span>
                      <span>{{ event.location_change_request.requested_location?.name }}</span>
                    </div>
                    <div *ngIf="event.location_change_request.requested_by" class="requested-by">
                      <span class="label">Requested by:</span>
                      <span>{{ event.location_change_request.requested_by.name }}</span>
                    </div>
                    <div *ngIf="event.location_change_request.approved_by" class="approved-by">
                      <span class="label">Approved by:</span>
                      <span>{{ event.location_change_request.approved_by.name }}</span>
                    </div>
                    <div *ngIf="event.payload?.reason" class="rejection-reason">
                      <span class="label">Reason:</span>
                      <span class="reason-text">{{ event.payload.reason }}</span>
                    </div>
                    <div *ngIf="event.location_change_request.notes" class="request-notes">
                      <span class="label">Notes:</span>
                      <span>{{ event.location_change_request.notes }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Pagination -->
          <div *ngIf="!historyLoading && history.length > 0 && historyLastPage > 1" class="history-pagination">
            <button
              mat-button
              [disabled]="historyPage === 1"
              (click)="goToHistoryPage(1)">
              First
            </button>
            <button
              mat-button
              [disabled]="historyPage === 1"
              (click)="previousHistoryPage()">
              Previous
            </button>
            <span class="page-info">Page {{ historyPage }} of {{ historyLastPage }}</span>
            <button
              mat-button
              [disabled]="historyPage >= historyLastPage"
              (click)="nextHistoryPage()">
              Next
            </button>
            <button
              mat-button
              [disabled]="historyPage >= historyLastPage"
              (click)="goToHistoryPage(historyLastPage)">
              Last
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Edit Mode -->
    <form *ngIf="isEditing" [formGroup]="assetForm" class="edit-mode">
      <mat-card class="asset-card">
        <mat-card-header>
          <mat-card-title>Edit Asset Information</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>Serial Number</mat-label>
              <input matInput formControlName="sn">
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Description</mat-label>
              <textarea matInput formControlName="description" rows="3"></textarea>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Status</mat-label>
              <mat-select formControlName="status_id">
                <mat-option *ngFor="let status of statuses" [value]="status.id">
                  {{ status.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Floor</mat-label>
              <mat-select formControlName="floor_id">
                <mat-option *ngFor="let floor of floors" [value]="floor.id">
                  {{ floor.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Supplier</mat-label>
              <input matInput
                     [formControl]="supplierControl"
                     [matAutocomplete]="supplierAuto">
              <mat-autocomplete #supplierAuto="matAutocomplete" [displayWith]="displaySupplier">
                <mat-option *ngFor="let supplier of filteredSuppliers$ | async" [value]="supplier">
                  {{ supplier.name }}
                </mat-option>
              </mat-autocomplete>
              <mat-hint>Start typing to search</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Holder</mat-label>
              <input matInput
                     [formControl]="holderUserControl"
                     [matAutocomplete]="userAuto">
              <mat-autocomplete #userAuto="matAutocomplete" [displayWith]="displayUser">
                <mat-option *ngFor="let user of filteredUsers$ | async" [value]="user">
                  {{ user.label || user.name }}
                </mat-option>
              </mat-autocomplete>
              <mat-hint>Start typing to search</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Acquisition Date</mat-label>
              <input matInput [matDatepicker]="acquisitionPicker" formControlName="acquisition_date">
              <mat-datepicker-toggle matSuffix [for]="acquisitionPicker"></mat-datepicker-toggle>
              <mat-datepicker #acquisitionPicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Acquisition Cost</mat-label>
              <input matInput type="number" formControlName="acquisition_cost">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Warranty Start Date</mat-label>
              <input matInput [matDatepicker]="warrantyStartPicker" formControlName="warranty_start_date">
              <mat-datepicker-toggle matSuffix [for]="warrantyStartPicker"></mat-datepicker-toggle>
              <mat-datepicker #warrantyStartPicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Warranty End Date</mat-label>
              <input matInput [matDatepicker]="warrantyEndPicker" formControlName="warranty_end_date">
              <mat-datepicker-toggle matSuffix [for]="warrantyEndPicker"></mat-datepicker-toggle>
              <mat-datepicker #warrantyEndPicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Budget Code</mat-label>
              <input matInput formControlName="budget_code">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Budget Donor</mat-label>
              <input matInput formControlName="budget_donor">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>PR</mat-label>
              <mat-select formControlName="pr_id">
                <mat-option *ngFor="let pr of prs" [value]="pr.id" [disabled]="pr.remaining_items_count === 0">
                  {{ pr.pr_code }}
                  <span class="ml-2 text-gray-500" *ngIf="pr.remaining_items_count !== undefined && pr.remaining_items_count !== null && pr.remaining_items_count > 0">
                    ({{ pr.remaining_items_count }} remaining)
                  </span>
                  <span *ngIf="pr.remaining_items_count === 0" class="text-gray-400 ml-2">(No remaining items)</span>
                </mat-option>
              </mat-select>
              <mat-hint>Purchase request selection</mat-hint>
            </mat-form-field>

            <!-- PR Details (shown when PR is selected) -->
            <div *ngIf="getSelectedPr()" class="p-4 bg-blue-50 rounded-lg border border-blue-200" style="grid-column: 1 / -1;">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <span class="text-sm font-medium text-gray-700">Total Items:</span>
                  <span class="ml-2 text-sm text-gray-900">{{ getSelectedPr()?.total_items_count ?? '—' }}</span>
                </div>
                <div>
                  <span class="text-sm font-medium text-gray-700">Remaining Items:</span>
                  <span class="ml-2 text-sm text-gray-900">{{ getSelectedPr()?.remaining_items_count ?? '—' }}</span>
                </div>
              </div>
            </div>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Notes</mat-label>
              <textarea matInput formControlName="notes" rows="3"></textarea>
            </mat-form-field>

            <!-- Dynamic Attributes -->
            <div *ngIf="dynamicAttributes.length > 0" class="dynamic-attributes">
              <h4>Additional Attributes</h4>
              <div class="attributes-grid">
                <div *ngFor="let attribute of dynamicAttributes; let i = index" class="attribute-field">
                  <mat-form-field *ngIf="attribute.type === 'select'" appearance="outline" class="w-full">
                    <mat-label>{{ attribute.name }}</mat-label>
                    <mat-select [formControl]="$any(getAttributeFormGroup(i).get('att_option_id'))">
                      <mat-option *ngFor="let option of getAttributeOptions(attribute.field_name)" [value]="option.id">
                        {{ option.value }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field *ngIf="attribute.type === 'text'" appearance="outline" class="w-full">
                    <mat-label>{{ attribute.name }}</mat-label>
                    <input matInput [formControl]="$any(getAttributeFormGroup(i).get('att_option_id'))">
                  </mat-form-field>

                  <mat-form-field *ngIf="attribute.type === 'number'" appearance="outline" class="w-full">
                    <mat-label>{{ attribute.name }}</mat-label>
                    <input matInput type="number" [formControl]="$any(getAttributeFormGroup(i).get('att_option_id'))">
                  </mat-form-field>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </form>
  </div>

  <!-- Error State -->
  <div *ngIf="!isLoading && !asset" class="error-container">
    <mat-icon color="warn">error</mat-icon>
    <h2>Asset Not Found</h2>
    <p>The requested asset could not be found.</p>
    <button mat-raised-button (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
      Back to Assets
    </button>
  </div>
</div>
