<div class="w-[100%] max-w-[1800px] mx-auto px-6 py-8">
  <div class="w-full max-w-12xl px-8 md:px-6 py-8 app-card">
    <!-- Header -->
    <div class="flex items-start justify-between gap-4 mb-6 ">
      <div>
        <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">Create Purchase Request</h1>
        <p class="text-sm text-gray-500 mt-1">
          Fill in the PR details and add as many items as needed. Attach the PR document before submitting.
        </p>
      </div>
      <a
      routerLink="/dashboard"
      class="inline-flex items-center gap-2 px-4 py-2 border border-gray-200 rounded-md text-sm text-gray-700 bg-white shadow-sm hover:bg-gray-50 transition"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
      </svg>
      Back
    </a>

    </div>

    <!-- Main grid -->
    <div class="w-[100%] max-w-[1800px] mx-auto px-16 py-18 ">
      <!-- Left (wide) -->
      <section class="space-y-6">
        <div *ngIf="serverErrors.length" class="mb-4 rounded-xl border border-rose-200 bg-rose-50 p-4 text-rose-800">
          <div class="font-semibold mb-1">Couldn’t submit the PR:</div>
          <ul class="list-disc pl-5 space-y-1 text-sm">
            <li *ngFor="let e of serverErrors">{{ e }}</li>
          </ul>
        </div>
        <form class="w-full" [formGroup]="form" (ngSubmit)="submit()">
          <!-- PR meta -->
          <div class=" md:p-16 p-16">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-12 app-card">
              <div class="md:col-span-1">
                <label class="block text-sm font-medium mb-1">PR Code<span class="text-rose-500">*</span></label>
                <input type="text" class="input" placeholder="PR-2025-001" formControlName="prCode" />
                <p *ngIf="form.get('prCode')?.touched && form.get('prCode')?.invalid"
                  class="text-xs text-rose-600 mt-1">
                  PR code is required.
                </p>
              </div>

              <div class="md:col-span-1">
                <label class="block text-sm font-medium mb-1">PR Date<span class="text-rose-500">*</span></label>
                <input type="date" class="input" formControlName="prDate" />
                <p *ngIf="form.get('prDate')?.touched && form.get('prDate')?.invalid"
                  class="text-xs text-rose-600 mt-1">
                  PR date is required.
                </p>
              </div>

              <!-- <div class="md:col-span-1">
              <label class="block text-sm font-medium mb-1">Notes</label>
              <input
                type="text"
                class="input"
                placeholder="Optional short note"
                formControlName="notes" />
            </div> -->
            </div>
          </div>


          <!-- Items table/card list -->
          <!-- ITEMS CARD -->
          <div class=" rounded-2xl p-16 mt-6 mb-8 app-card">
            <div class="flex items-center justify-between mb-5">
              <h2 class="text-lg font-semibold">Items</h2>
              <button type="button" (click)="addItemRow()" class="btn-primary">＋ Add Item</button>
            </div>

            <!-- No overflow wrappers here -->
            <div formArrayName="items" class="space-y-5 p-10">
              <div *ngFor="let row of items.controls; let i = index; trackBy: trackByIndex" [formGroupName]="i"
                class="rounded-2xl border border-emerald-200/60 bg-emerald-300/20 p-4 md:p-5 p-10">

                <!-- Row A: 4 big selects across, responsive to 2x2 on small screens -->
                <div class="grid grid-cols-12 gap-4">
                  <div class="col-span-12 sm:col-span-6 lg:col-span-4">
                    <label class="label">Category<span class="req">*</span></label>
                    <!-- Category -->
                    <select class="input input-lg" formControlName="category">
                      <option [ngValue]="null" disabled>Select category ..</option>
                      <option *ngFor="let c of categories" [ngValue]="c.id">{{ c.label }}</option>
                    </select>
                  </div>

                  <div class="col-span-12 sm:col-span-6 lg:col-span-4">
                    <label class="label">Sub-Category<span class="req">*</span></label>
                    <select class="input input-lg" formControlName="subCategory">
                      <option [ngValue]="null" disabled>Select Sub Category..</option>
                      <option *ngFor="let s of subOptions[i]" [ngValue]="s.id">{{ s.label }}</option>
                    </select>
                  </div>

                  <div class="col-span-12 sm:col-span-6 lg:col-span-4">
                    <label class="label">Item<span class="req">*</span></label>
                    <select class="input input-lg" formControlName="item">
                      <option [ngValue]="null" disabled>Select item...</option>
                      <option *ngFor="let it of itemOptions[i]" [ngValue]="it.id">{{ it.label }}</option>
                    </select>
                  </div>


                </div>

                <!-- Row B: qty, price, currency, total, remove -->
                <div class="grid grid-cols-12 gap-4 mt-3">
                  <!-- <div class="col-span-6 sm:col-span-3 lg:col-span-2">
          <label class="label">Qty</label>
          <input type="number" min="1" class="input input-lg" formControlName="quantity" />
        </div>

        <div class="col-span-6 sm:col-span-3 lg:col-span-3">
          <label class="label">Unit Price</label>
          <input type="number" min="0" step="0.01" class="input input-lg" formControlName="unitPrice" />
        </div>

        <div class="col-span-6 sm:col-span-3 lg:col-span-2">
          <label class="label">Curr</label>
          <select class="input input-lg" formControlName="currency">
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="LBP">LBP</option>
          </select>
        </div> -->

                  <div class="col-span-12 sm:col-span-6 lg:col-span-4">
                    <label class="label">Supplier<span class="req">*</span></label>

                    <!-- Bind to the existing form control "supplier" (which will hold supplier_id) -->
                    <!-- Optionally pass [categoryId]="row.value.category" if your backend filters suppliers by category -->
                    <app-supplier-typeahead formControlName="supplier" placeholder="Search supplier…">
                    </app-supplier-typeahead>
                  </div>

                  <!-- <div class="col-span-12 sm:col-span-6 lg:col-span-4">
          <label class="label">Supplier<span class="req">*</span></label>
          <select class="input input-lg" formControlName="supplier">
            <option value="" disabled>Select supplier...</option>
            <option *ngFor="let s of suppliers" [value]="s.id">{{ s.label }}</option>
          </select>
        </div> -->

                  <!-- <div class="col-span-6 sm:col-span-3 lg:col-span-4">
          <label class="label">Price</label>
          <div class="input input-lg bg-gray-50 border-gray-200 flex items-center">
            {{ rowTotal(i) | number:'1.2-2' }}
          </div>
        </div> -->

                  <div class="col-span-6 sm:col-span-3 lg:col-span-4">
                    <label class="label">Unit Cost (USD)<span class="req">*</span></label>
                    <input type="number" min="0" step="0.01" class="input input-lg" formControlName="unit_cost" />
                  </div>

                  <div class="col-span-6 sm:col-span-3 lg:col-span-4">
                    <label class="label">Line Total</label>
                    <div class="input input-lg bg-gray-50 border-gray-200 flex items-center">
                      {{ rowTotal(i) | number:'1.2-2' }}
                    </div>
                  </div>


                  <div class="col-span-12 sm:col-span-12 lg:col-span-2 flex lg:justify-end items-end">
                    <button type="button" (click)="removeItemRow(i)"
                      class="w-full lg:w-auto px-4 h-11 rounded-xl border border-gray-300 hover:bg-gray-50 btn-primary">
                      Remove
                    </button>
                  </div>
                </div>

                <!-- Row C: remark full width -->
                <!-- <div class="mt-3">
        <label class="label">Remark</label>
        <input type="text" class="input input-lg" formControlName="remark" placeholder="Optional remark for this line item" />
      </div> -->
              </div>
            </div>

            <!-- Footer total -->
            <div class="flex items-center justify-end mt-6">
              <div class="text-sm text-gray-500 mr-3">Grand Total</div>
              <div class="text-2xl font-semibold">{{ grandTotal() | number:'1.2-2' }}</div>
            </div>
          </div>


          <!-- Mobile submit -->
          <div class="md:hidden">
            <button (click)="submit()" class="w-full h-12 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700
         disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center justify-center gap-2"
              [disabled]="form.invalid || submitting" type="button">
              <svg *ngIf="submitting" class="w-5 h-5 animate-spin" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" opacity=".2" />
                <path d="M22 12a10 10 0 0 1-10 10" stroke="currentColor" stroke-width="4" />
              </svg>
              <span>{{ submitting ? 'Submitting…' : 'Submit PR' }}</span>
            </button>
            <!-- <button (click)="submit()" class="w-full h-12 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">
              Submit PR
            </button> -->
          </div>
        </form>
      </section>

      <!-- Right (summary / upload) -->
      <aside class="space-y-6">
        <!-- Upload -->
        <!-- Upload panel -->
        <div class="bg-white rounded-2xl shadow-sm  p-5 app-card">
          <h3 class="text-lg font-semibold mb-3">Upload PR Document <span class="text-rose-600">*</span></h3>

          <label class="block rounded-2xl border-2 border-dashed p-6 text-center cursor-pointer transition
           hover:bg-emerald-50" [class.border-emerald-400]="isDragOver" [class.bg-emerald-50]="isDragOver"
            [class.border-rose-400]="form.get('document')?.touched && form.get('document')?.invalid">
            <input type="file" class="hidden" (change)="onFileSelected($event)" />
            <div class="flex flex-col items-center gap-2">
              <!-- icon ... -->
              <div class="text-sm text-gray-600">Click to upload or drag & drop</div>
              <div class="text-xs text-gray-400">PDF, DOCX, PNG up to 10MB</div>
            </div>
          </label>

          <p *ngIf="form.get('document')?.touched && form.get('document')?.invalid" class="text-xs text-rose-600 mt-2">
            Document is required.
          </p>

          <div *ngIf="uploadedFile" class="mt-3 flex items-center justify-between rounded-xl border p-3">
            <div class="text-sm">
              <div class="font-medium">{{ uploadedFile.name }}</div>
              <div class="text-gray-500 text-xs">{{ uploadedFile.size | number }} bytes</div>
            </div>
            <button class="px-3 h-9 rounded-lg border hover:bg-gray-50" (click)="setFile(null)">Remove</button>
          </div>
        </div>

        <!-- Quick tips / meta -->
        <div class="bg-white rounded-2xl app-card p-5">
          <h3 class="text-lg font-semibold mb-3">Tips</h3>
          <ul class="text-sm text-gray-600 list-disc pl-5 space-y-2">
            <li>Use <span class="font-medium">Add Item</span> to include multiple lines.</li>
            <li>Totals update automatically as you enter quantity and unit price.</li>
            <li>Attach the official PR document before submitting.</li>
          </ul>
        </div>
        <div class="hidden md:flex items-center gap-3">
          <button class="px-4 h-10 rounded-xl border border-gray-200 hover:bg-gray-50">Cancel</button>
          <button (click)="submit()" class="px-5 h-10 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 shadow-sm
         disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center gap-2"
            [disabled]="form.invalid || submitting" type="button">
            <svg *ngIf="submitting" class="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" opacity=".2" />
              <path d="M22 12a10 10 0 0 1-10 10" stroke="currentColor" stroke-width="4" />
            </svg>
            <span>{{ submitting ? 'Submitting…' : 'Submit PR' }}</span>
          </button>
          <!-- <button (click)="submit()"
            class="px-5 h-10 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 shadow-sm">
            Submit PR
          </button> -->
        </div>
        <div class="md:hidden">
          <button (click)="submit()" class="px-5 h-10 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 shadow-sm
         disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center gap-2"
            [disabled]="form.invalid || submitting" type="button">
            <svg *ngIf="submitting" class="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" opacity=".2" />
              <path d="M22 12a10 10 0 0 1-10 10" stroke="currentColor" stroke-width="4" />
            </svg>
            <span>{{ submitting ? 'Submitting…' : 'Submit PR' }}</span>
          </button>
          <!-- <button (click)="submit()"
            class="w-full h-12 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed"
            [disabled]="form.invalid" type="button">
            Submit PR
          </button> -->
        </div>
      </aside>
    </div>
  </div>
</div>